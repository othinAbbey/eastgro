///----------Organised------------------
// ========================= ENUMS =========================
enum ProduceStatus {
  HARVESTED
  IN_TRANSIT
  PROCESSED
  DELIVERED
}

enum ShipmentStatus {
  PENDING
  IN_TRANSIT
  DELIVERED
  RETURNED
}

enum QualityGrade {
  A
  B
  C
  D
  FAILED
}

enum ProblemStatus {
  REPORTED
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum UserRole {
  ADMIN
  FARMER
  CUSTOMER
  TRANSPORTER
  FACILITY_MANAGER
  AGENT
  EXPERT
}

enum TraceActionType {
  HARVESTED
  LOADED
  TRANSPORTED
  STORED
  DELIVERED
  SOLD
}

// ====================== CONFIGURATION ======================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ========================= MODELS =========================

// -------- Product & Market --------
model Product {
  id        String   @id @default(uuid())
  name      String
  price     Int
  unit      String   @default("Kgs")
  quantity  Int
  createdAt DateTime @default(now())

  // Relations
  Processing_Facility Facility[]      @relation("FacilityProducts")
  QR_code             QRCode[]        @relation("QRCodeProducts")
  shipment            Shipment[]      @relation("ShipmentProducts")
  farmer              Farmer[]        @relation("FarmerProducts")
  produce             Produce[]       @relation("ProduceProducts")
  transporter         Transporter?    @relation(fields: [transporterId], references: [id])
  transporterId       String?
  marketListings      MarketListing[]
  transactions        Transaction[]   @relation("TransactionProducts")

  TraceabilityLog TraceabilityLog[]
}

model MarketListing {
  id          String   @id @default(uuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  sellerId    String
  sellerType  String
  price       Int
  quantity    Int
  location    String
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// -------- Produce Flow --------
model Produce {
  id             String        @id @default(uuid())
  type           String
  region         String        @default("Eastern")
  quantity       Int
  price          Int           @default(0)
  unit           String        @default("kgs")
  harvestDate    DateTime
  qualityReport  QualityGrade?
  status         ProduceStatus @default(HARVESTED)
  isBiofortified Boolean       @default(false)
  createdAt      DateTime      @default(now())

  farmerId       String?
  farmer         Farmer?          @relation(fields: [farmerId], references: [id])
  qrCode         QRCode?
  shipments      Shipment[]
  storage        Storage?
  loadAtFacility loadAtFacility[]
  facilities     Facility[]       @relation("ProduceFacilities")
  products       Product[]        @relation("ProduceProducts")
  transactions   Transaction[]    @relation("TransactionProduce")

  TraceabilityLog TraceabilityLog[]
}

model Storage {
  id         String   @id @default(uuid())
  facilityId String
  produceId  String   @unique
  quantity   Int
  storedAt   DateTime @default(now())

  facility  Facility   @relation(fields: [facilityId], references: [id])
  produce   Produce    @relation(fields: [produceId], references: [id])
  shipments Shipment[]
}

model loadAtFacility {
  id         String   @id @default(uuid())
  facilityId String
  produceId  String
  quantity   Int
  loadedAt   DateTime @default(now())

  facility  Facility   @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  produce   Produce    @relation(fields: [produceId], references: [id])
  shipments Shipment[]
}

model QRCode {
  id          String    @id @default(uuid())
  produceId   String    @unique
  generatedAt DateTime  @default(now())
  scannedAt   DateTime?

  produce  Produce   @relation(fields: [produceId], references: [id])
  products Product[] @relation("QRCodeProducts")
}

// -------- Shipment & Transport --------
model Shipment {
  id           String         @id @default(uuid())
  destination  String
  status       ShipmentStatus @default(PENDING)
  deliveryDate DateTime?

  produceId     String
  transporterId String?
  facilityId    String?
  storageId     String?

  produce        Produce          @relation(fields: [produceId], references: [id])
  transporter    Transporter?     @relation(fields: [transporterId], references: [id])
  facility       Facility?        @relation(fields: [facilityId], references: [id])
  storage        Storage?         @relation(fields: [storageId], references: [id])
  loadAtFacility loadAtFacility[]
  products       Product[]        @relation("ShipmentProducts")
}

model Transporter {
  id             String  @id @default(uuid())
  name           String
  contact        String
  vehicleDetails String?
  status         String
  Region         String

  shipments Shipment[]
  products  Product[]
}

// -------- Facilities --------
model Facility {
  id                String  @id @default(uuid())
  name              String
  location          String
  processingDetails String?
  workload          Int     @default(0)

  shipments       Shipment[]
  storage         Storage[]
  loads           loadAtFacility[]
  producesHandled Produce[]        @relation("ProduceFacilities")
  products        Product[]        @relation("FacilityProducts")
}

// -------- Users (Farmer & Customer) --------
model Farmer {
  id          String  @id @default(uuid())
  name        String
  contact     String  @unique
  location    String
  password    String
  farmDetails String?
  //make farmer use roleenums
  // role        String  @default("FARMER")
  // role UserRole @default(FARMER)


  groupId  String?
  group    Group?     @relation("GroupFarmers", fields: [groupId], references: [id])
  produce  Produce[]
  problems Problem[]
  products Product[]  @relation("FarmerProducts")
  FarmPlan FarmPlan[]

  Report Report[]
}

model Customer {
  id              String   @id @default(uuid())
  name            String
  contact         String   @unique
  password        String
  purchaseHistory String?
  // role            String   @default("customer")
  // role UserRole @default(FARMER)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  transactions Transaction[]
}

// -------- Groups --------
model Group {
  id            String   @id @default(uuid())
  cropType      String
  region        String
  totalQuantity Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  farmers Farmer[] @relation("GroupFarmers")
}

// -------- Problem Reporting --------
model Problem {
  id       String @id @default(uuid())
  farmtype String
  Crop     String
  Disease  String
  Pest     String
  farmerId String

  farmer   Farmer            @relation(fields: [farmerId], references: [id])
  progress ProblemProgress[]
  reportId String?
  report   Report? @relation(fields: [reportId], references: [id])

}

model ProblemProgress {
  id        String        @id @default(uuid())
  problemId String
  update    String
  updatedBy String
  status    ProblemStatus @default(REPORTED)
  updatedAt DateTime      @default(now())

  problem Problem @relation(fields: [problemId], references: [id])
}

// -------- Reports --------
// model Report {
//   id   String   @id @default(uuid())
//   From DateTime
//   To   DateTime
// }

model Report {
  id        String    @id @default(uuid())
  startDate String
  endDate   String
  farmerId  String
  farmer    Farmer    @relation(fields: [farmerId], references: [id])
  problems  Problem[] // optional one-to-many
}


model FarmInput {
  id           String        @id @default(uuid())
  name         String
  type         String
  quantity     Int
  unit         String
  price        Int           @default(0)
  createdAt    DateTime      @default(now())
  transactions Transaction[] @relation("TransactionInputs")
}

// -------- Users Table --------
model User {
  id        String   @id @default(uuid())
  name      String
  contact   String   @unique
  email     String   @unique
  password  String
  UserRole  String   @default("CUSTOMER") 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -------- Traceability Logs --------
model TraceabilityLog {
  id         String          @id @default(uuid())
  actionType TraceActionType
  productId  String
  timestamp  DateTime        @default(now())

  product Product @relation(fields: [productId], references: [id])
  produceId String?
  produce    Produce? @relation(fields: [produceId], references: [id])

}

// ================== SERVICE PROVIDERS ==================
model ServiceProvider {
  id              String             @id @default(uuid())
  name            String
  contact         String             @unique
  email           String             @unique
  password        String
  businessName    String
  description     String?
  location        String
  region          String             @default("Eastern")
  rating          Float?             @default(0.0)
  isVerified      Boolean            @default(false)
  role            UserRole           @default(EXPERT)
  createdAt       DateTime           @default(now())
  // updatedAt DateTime @updatedAt()
  // Service details
  servicesOffered ServiceOfferings[]
  qualifications  String[] // Array of certifications/qualifications
  equipment       String[] // Array of equipment available
  minOrderAmount  Float? // Minimum order value required
  availability    String             @default("Monday-Friday, 8AM-5PM")
  travelRadius    Int? // Maximum distance they'll travel (in km)
  profileImage    String? // URL to profile image

  // Relations
  transactions Transaction[] @relation("ServiceProviderTransactions")
}

// model ServiceOffering {
//   id                String  @id @default(uuid())
//   serviceId         String
//   serviceProviderId String
//   rate              Float // Custom rate for this provider (can differ from base price)
//   minQuantity       Int?    @default(1) // Minimum quantity required
//   unit              String  @default("session")
//   notes             String? // Any special notes about this service
//   isActive          Boolean @default(true)

//   // Relations
//   service         Service         @relation(fields: [serviceId], references: [id])
//   serviceProvider ServiceProvider @relation(fields: [serviceProviderId], references: [id])
// }

model ServiceOfferings {
  id                String  @id @default(uuid())
  serviceId         String
  serviceProviderId String
  rate              Float // Custom rate for this provider (can differ from base price)
  minQuantity       Int?    @default(1) // Minimum quantity required
  unit              String  @default("session")
  notes             String? // Any special notes about this service
  isActive          Boolean @default(true)

  // Relations
  service         Service         @relation(fields: [serviceId], references: [id])
  serviceProvider ServiceProvider @relation(fields: [serviceProviderId], references: [id])

  Transaction Transaction[]
}

// Update existing Service model to connect with providers
model Service {
  id          String   @id @default(uuid())
  name        String
  description String
  basePrice   Float // Default/base price
  category    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Add provider relationship
  providers ServiceOfferings[]

  // Existing relation
  transactions Transaction[] @relation("TransactionServices")
}

// Update Transaction model to include service provider
// model Transaction {
//   id            String @id @default(uuid())
//   buyerId       String
//   totalAmount   Int
//   paymentMethod String @default("CASH")
//   status        String @default("PENDING")

//   // Add service provider reference
//   serviceProviderId String?
//   serviceProvider   ServiceProvider? @relation(fields: [serviceProviderId], references: [id], name: "ServiceProviderTransactions")

//   // Existing relations
//   buyer     Customer    @relation(fields: [buyerId], references: [id])
//   products  Product[]   @relation("TransactionProducts")
//   produce   Produce[]   @relation("TransactionProduce")
//   services  Service[]   @relation("TransactionServices")
//   FarmInput FarmInput[] @relation("TransactionInputs")
// }

model Transaction {
  id            String @id @default(uuid())
  buyerId       String
  totalAmount   Int
  paymentMethod String @default("CASH")
  status        String @default("PENDING")

  // Add service provider reference
  serviceProviderId String?
  serviceProvider   ServiceProvider? @relation(fields: [serviceProviderId], references: [id], name: "ServiceProviderTransactions")

  // Existing relations
  buyer            Customer           @relation(fields: [buyerId], references: [id])
  products         Product[]          @relation("TransactionProducts")
  produce          Produce[]          @relation("TransactionProduce")
  services         Service[]          @relation("TransactionServices")
  FarmInput        FarmInput[]        @relation("TransactionInputs")
  serviceOfferings ServiceOfferings[]
}

////======================Farm Management=========================
//// Agronomy Information

model Crop {
  id           String         @id @default(uuid())
  name         String         @unique
  description  String
  agronomy     Agronomy[]
  inputs       CropInput[]
  pests        Pest[]
  diseases     Disease[]
  CropVariety  CropVariety[]
  CostTemplate CostTemplate[]
}

model Agronomy {
  id      String @id @default(uuid())
  content String // Could be bullet points in markdown or separate items
  cropId  String
  crop    Crop   @relation(fields: [cropId], references: [id])
}

model CropInput {
  id          String @id @default(uuid())
  name        String
  type        String // E.g. Herbicide, Fertilizer, etc.
  description String
  cropId      String
  crop        Crop   @relation(fields: [cropId], references: [id])
}

model Pest {
  id          String  @id @default(uuid())
  name        String
  description String
  control     String? // Optional: How to control it
  cropId      String
  crop        Crop    @relation(fields: [cropId], references: [id])
}

model Disease {
  id          String  @id @default(uuid())
  name        String
  description String
  treatment   String? // Optional: How to treat it
  cropId      String
  crop        Crop    @relation(fields: [cropId], references: [id])
}

///=======Farm Managemnt======
enum CostType {
  ONE_TIME
  SEASONAL
  INVESTMENTCOSTS
}

enum Stage {
  LAND_PREPARATION
  PLANTING
  MANAGEMENT
  HARVEST
  POST_HARVEST
  MARKETING
}

model CropVariety {
  id               String     @id @default(uuid())
  name             String
  description      String
  daysToMaturity   Int
  yieldPotential   String
  kgPerAcre        Int // ✅ Add this to CropVariety model
  yieldPerAcre     String // ✅ Add this to CropVariety model
  cropId           String
  crop             Crop       @relation(fields: [cropId], references: [id])
  FarmPlan         FarmPlan[]
  marketPricePerKg Float? // Optional: Market price per kg for this variety
}

model FarmPlan {
  id           String   @id @default(uuid())
  name         String
  plantingDate DateTime
  gardenSize   Float
  farmerId     String
  varietyId    String

  // Estimates
  estimatedYield   Float?
  estimatedRevenue Float?
  estimatedProfit  Float?

  farmer     Farmer         @relation(fields: [farmerId], references: [id])
  variety    CropVariety    @relation(fields: [varietyId], references: [id])
  costs      Cost[]
  activities FarmActivity[]
  records    FarmRecord[]
}

// model CostTemplate {
//   id       String   @id @default(uuid())
//   costName String
//   type     CostType
//   stage    Stage
//   amount   Float
//   cropId   String
//   crop     Crop     @relation(fields: [cropId], references: [id])
// }
model CostTemplate {
  id          String   @id @default(uuid())
  cropId      String
  type        CostType
  stage       Stage
  // category    String
  description String?
  amount      Float
  isRequired  Boolean  @default(true)

  crop Crop @relation(fields: [cropId], references: [id])
}
model Cost {
  id          String   @id @default(uuid())
  farmPlanId  String
  type        CostType
  stage       Stage
  // category    String
  description String?
  amount      Float
  isCustom    Boolean  @default(false)

  farmPlan FarmPlan @relation(fields: [farmPlanId], references: [id])
}

model FarmActivity {
  id          String   @id @default(uuid())
  farmPlanId  String
  title       String
  description String?
  photoUrl    String?
  timestamp   DateTime @default(now())

  farmPlan FarmPlan @relation(fields: [farmPlanId], references: [id])
}

model FarmRecord {
  id         String   @id @default(uuid())
  farmPlanId String
  type       String
  details    String
  createdAt  DateTime @default(now())

  farmPlan FarmPlan @relation(fields: [farmPlanId], references: [id])
}
